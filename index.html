<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8">
<title>POS Market â€“ FINAL STABLE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Segoe UI;background:#eef2f7}
header{background:#1e293b;color:#fff;padding:12px}
nav button{margin:4px;padding:10px;border:none;border-radius:10px;background:#334155;color:#fff}
section{display:none;padding:15px}
section.active{display:block}
.card{background:#fff;padding:15px;border-radius:14px;margin-bottom:12px;box-shadow:0 8px 18px rgba(0,0,0,.1)}
input,button{padding:8px;border-radius:8px;border:1px solid #cbd5f5}
button{background:#2563eb;color:#fff;font-weight:600;margin:3px}
button.alt{background:#0f766e}
button.warn{background:#b91c1c}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px;border-bottom:1px solid #e5e7eb;text-align:center}
th{background:#f1f5f9}
.admin{display:none}
.qtyBtn{padding:4px 8px}
video{width:100%;max-height:220px;border-radius:12px;background:#000}
</style>
</head>

<body>

<header>
<h2>ğŸ›’ POS Market</h2>
<nav id="menu" style="display:none">
<button onclick="openSec('stock')" class="admin">Stok</button>
<button onclick="openSec('sale')">Shitje</button>
<button onclick="openSec('bil')" class="admin">Bilanc</button>
<button onclick="logout()">Dil</button>
</nav>
</header>

<!-- LOGIN -->
<section id="loginSec" class="active">
<div class="card">
<h3>Login</h3>
<input id="u" placeholder="user">
<input id="p" type="password" placeholder="pass">
<button onclick="doLogin()">Login</button>
<p id="msg" style="color:red"></p>
</div>
</section>

<!-- STOK -->
<section id="stock">
<div class="card admin">
<h3>Shto Produkt</h3>
<input id="sn" placeholder="Emri">
<input id="sb" placeholder="Barkod">
<input id="sp" type="number" placeholder="Ã‡mimi">
<input id="ss" type="number" placeholder="Sasia">
<button onclick="addProd()">â• Shto</button>
</div>

<div class="card">
<table id="stockTable"></table>
</div>
</section>

<!-- SHITJE -->
<section id="sale">
<div class="card">
<input id="scan" placeholder="Scan barkod / emÃ«r (USB punon direkt)" autofocus>
<button class="alt" onclick="startCam()">ğŸ“· Kamera</button>
<button onclick="addSale()">Shto</button>
</div>

<div class="card" id="camBox" style="display:none">
<video id="video" autoplay></video>
<button class="warn" onclick="stopCam()">Mbyll KamerÃ«n</button>
</div>

<div class="card">
<table id="saleTable"></table>
<h3>Total: <span id="total">0</span> ALL</h3>
<input id="paid" type="number" placeholder="Paguar">
<h3>Kusur: <span id="change">0</span></h3>
<button onclick="pay()">Paguaj</button>
</div>
</section>

<!-- BILANC -->
<section id="bil" class="admin">
<div class="card">
<h3>ğŸ“Š Bilanc Ditor</h3>
<p>Shitje sipas sistemit: <b><span id="daily">0</span> ALL</b></p>
<input id="cashReal" type="number" placeholder="Para reale nÃ« arkÃ«">
<p>Diferenca: <b><span id="diff">0</span> ALL</b></p>
<button onclick="closeDay()">Mbyll DitÃ«n</button>
</div>
</section>

<script>
// ================= USERS =================
const USERS=[
 {u:'admin',p:'admin',r:'admin'},
 {u:'kasier',p:'kasier',r:'kasier'}
];

let role=null;
let products=JSON.parse(localStorage.getItem('products')||'[]');
let sales=[];
let daily=+localStorage.getItem('daily')||0;

// ================= LOGIN =================
function doLogin(){
 const f=USERS.find(x=>x.u===u.value&&x.p===p.value);
 if(!f){msg.textContent='Login gabim';return;}
 role=f.r;
 loginSec.style.display='none';
 menu.style.display='block';
 document.querySelectorAll('.admin')
  .forEach(e=>e.style.display=role==='admin'?'block':'none');
 openSec('sale');
 renderStock();updateDaily();
}
function logout(){location.reload();}
function openSec(id){
 document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
 document.getElementById(id).classList.add('active');
}

// ================= STOK =================
function addProd(){
 if(!sn.value||!sb.value)return alert('PlotÃ«so tÃ« dhÃ«nat');
 products.push({n:sn.value,b:sb.value,p:+sp.value||0,s:+ss.value||0});
 save();sn.value=sb.value=sp.value=ss.value='';
}
function deleteStock(i){
 if(confirm('Fshi produktin nga stoku?')){
  products.splice(i,1);save();
 }
}
function renderStock(){
 stockTable.innerHTML='<tr><th>EmÃ«r</th><th>Barkod</th><th>Ã‡mim</th><th>Stok</th><th>ğŸ—‘ï¸</th></tr>';
 products.forEach((p,i)=>{
  stockTable.innerHTML+=`
  <tr>
   <td>${p.n}</td>
   <td>${p.b}</td>
   <td>${p.p}</td>
   <td>${p.s}</td>
   <td><button onclick="deleteStock(${i})">ğŸ—‘ï¸</button></td>
  </tr>`;
 });
}

// ================= SHITJE =================
scan.addEventListener('keydown',e=>{if(e.key==='Enter')addSale();});

function addSale(){
 const v=scan.value.trim().toLowerCase();
 if(!v)return;
 const p=products.find(x=>x.b===v||x.n.toLowerCase().includes(v));
 if(!p||p.s<1)return alert('Nuk ka stok');
 let s=sales.find(x=>x.b===p.b);
 if(s){if(s.q<p.s)s.q++;}
 else sales.push({b:p.b,n:p.n,p:p.p,q:1});
 drawSale();scan.value='';
}

function drawSale(){
 saleTable.innerHTML='<tr><th>Produkt</th><th>Sasi</th><th>Stok</th><th>Total</th><th>ğŸ—‘ï¸</th></tr>';
 sales.forEach((x,i)=>{
  const pr=products.find(p=>p.b===x.b);
  saleTable.innerHTML+=`
  <tr>
   <td>${x.n}</td>
   <td>
    <button class="qtyBtn" onclick="chg(${i},-1)">â–</button>
    ${x.q}
    <button class="qtyBtn" onclick="chg(${i},1)">â•</button>
   </td>
   <td>
    <input type="number" value="${pr.s}" style="width:60px"
     onchange="editStock('${x.b}',this.value)">
   </td>
   <td>${x.q*x.p}</td>
   <td><button onclick="rem(${i})">ğŸ—‘ï¸</button></td>
  </tr>`;
 });
 recalc();
}

function chg(i,d){
 const pr=products.find(p=>p.b===sales[i].b);
 sales[i].q=Math.max(1,Math.min(pr.s,sales[i].q+d));
 drawSale();
}
function rem(i){sales.splice(i,1);drawSale();}
function editStock(b,v){
 const pr=products.find(p=>p.b===b);
 pr.s=+v||0;save();
}
function recalc(){
 let t=0;sales.forEach(x=>t+=x.q*x.p);
 total.textContent=t;
 change.textContent=(+paid.value||0)-t;
}
paid.oninput=recalc;

function pay(){
 const t=+total.textContent;
 const c=+paid.value||0;
 if(t<1)return alert('AsgjÃ« pÃ«r paguar');
 if(c<t)return alert('MungojnÃ« para');
 sales.forEach(x=>products.find(p=>p.b===x.b).s-=x.q);
 daily+=t;localStorage.setItem('daily',daily);
 sales=[];saleTable.innerHTML='';
 total.textContent=0;paid.value='';change.textContent=0;
 save();updateDaily();
 alert('Pagesa u krye');
}

// ================= BILANC =================
const dailyEl=daily;
function updateDaily(){document.getElementById('daily').textContent=daily;}
cashReal.addEventListener('input',()=>{
 const d=(+cashReal.value||0)-daily;
 diff.textContent=d;diff.style.color=d<0?'red':'green';
});
function closeDay(){
 const real=+cashReal.value||0;
 const d=real-daily;
 alert(`Shitje sistem: ${daily} ALL\nArka reale: ${real} ALL\nDiferenca: ${d} ALL`);
 daily=0;localStorage.setItem('daily',0);
 cashReal.value='';diff.textContent='0';updateDaily();
}

// ================= CAMERA =================
let stream=null,detector=null;
async function startCam(){
 if(!('BarcodeDetector'in window))return alert('Browser nuk e suporton kamerÃ«n');
 detector=new BarcodeDetector({formats:['ean_13','ean_8','code_128']});
 stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
 video.srcObject=stream;camBox.style.display='block';
 scanLoop();
}
async function scanLoop(){
 if(!stream)return;
 const codes=await detector.detect(video);
 if(codes[0]){scan.value=codes[0].rawValue;addSale();}
 requestAnimationFrame(scanLoop);
}
function stopCam(){
 if(stream)stream.getTracks().forEach(t=>t.stop());
 stream=null;camBox.style.display='none';
}

// ================= SAVE =================
function save(){
 localStorage.setItem('products',JSON.stringify(products));
 renderStock();
}
</script>

</body>
</html>
