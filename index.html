<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8">
<title>POS Market â€“ FINAL STABLE (FIXED)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Segoe UI;background:#eef2f7}
header{background:#1e293b;color:#fff;padding:12px}
nav button{margin:4px;padding:10px;border:none;border-radius:10px;background:#334155;color:#fff}
section{display:none;padding:15px}
section.active{display:block}
.card{background:#fff;padding:15px;border-radius:14px;margin-bottom:12px;box-shadow:0 8px 18px rgba(0,0,0,.1)}
input,button{padding:8px;border-radius:8px;border:1px solid #cbd5f5}
button{background:#2563eb;color:#fff;font-weight:600;margin:3px}
button.alt{background:#0f766e}
button.warn{background:#b91c1c}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px;border-bottom:1px solid #e5e7eb;text-align:center}
th{background:#f1f5f9}
.admin{display:none}
.qtyBtn{padding:4px 8px}
</style>
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>
</head>
<body>
<header>
<h2>ğŸ›’ POS Market</h2>
<nav id="menu" style="display:none">
<button onclick="openSec('stock')" class="admin">Stok</button>
<button onclick="openSec('sale')">Shitje</button>
<button onclick="openSec('bil')" class="admin">Bilanc</button>
<button onclick="logout()">Dil</button>
</nav>
</header>

<section id="loginSec" class="active">
<div class="card">
<h3>Login</h3>
<input id="u" placeholder="user">
<input id="p" type="password" placeholder="pass">
<button onclick="doLogin()">Login</button>
<p id="msg" style="color:red"></p>
</div>
</section>

<section id="stock">
<div class="card admin">
<h3>Shto / Edito Produkt</h3>
<input id="sn" placeholder="Emri">
<input id="sb" placeholder="Barkod">
<input id="sp" type="number" placeholder="Ã‡mimi">
<input id="ss" type="number" placeholder="Sasia">
<button onclick="addProd()">â• Shto</button>
<button class="alt" onclick="openCam('stock')">ğŸ“· Kamera</button>
</div>
<div class="card"><table id="stockTable"></table></div>
</section>

<section id="sale">
<div class="card">
<input id="scan" placeholder="Scan barkod / USB" autofocus>
<button class="alt" onclick="openCam('sale')">ğŸ“· Kamera</button>
<button onclick="addSale()">Shto</button>
</div>
<div class="card">
<table id="saleTable"></table>
<h3>Total: <span id="total">0</span> ALL</h3>
<input id="paid" type="number" placeholder="Paguar">
<h3>Kusur: <span id="change">0</span></h3>
<button onclick="pay()">Paguaj</button>
</div>
</section>

<section id="bil" class="admin">
<div class="card">
<h3>ğŸ“Š Bilanc Ditor</h3>
<p>Shitje sistem: <b><span id="daily">0</span> ALL</b></p>
<input id="cashReal" type="number" placeholder="Para reale nÃ« arkÃ«">
<p>Diferenca: <b><span id="diff">0</span> ALL</b></p>
<button onclick="closeDay()">Mbyll DitÃ«n</button>
</div>
</section>

<div id="camModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999">
<div class="card" style="max-width:420px;margin:40px auto">
<div id="scanner" style="height:260px"></div>
<button class="warn" onclick="closeCam()">Mbyll KamerÃ«n</button>
</div>
</div>

<script>
// ===== USERS =====
const USERS=[{u:'admin',p:'admin',r:'admin'},{u:'kasier',p:'kasier',r:'kasier'}];
let role=null;

// ===== DATA =====
let products=JSON.parse(localStorage.getItem('products')||'[]');
let sales=[];
let dailyValue=Number(localStorage.getItem('daily')||0);

// ===== LOGIN =====
function doLogin(){
 const f=USERS.find(x=>x.u===u.value&&x.p===p.value);
 if(!f){msg.textContent='Login gabim';return;}
 role=f.r;
 loginSec.style.display='none';
 menu.style.display='block';
 document.querySelectorAll('.admin').forEach(e=>e.style.display=role==='admin'?'block':'none');
 openSec('sale');
 renderStock();
 updateDaily();
}
function logout(){location.reload();}
function openSec(id){document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}

// ===== STOK =====
function addProd(){
 if(!sn.value||!sb.value)return alert('PlotÃ«so tÃ« dhÃ«nat');
 products.push({n:sn.value,b:sb.value,p:+sp.value||0,s:+ss.value||0});
 sn.value=sb.value=sp.value=ss.value='';
 save();
}
function renderStock(){
 stockTable.innerHTML='<tr><th>EmÃ«r</th><th>Barkod</th><th>Ã‡mim</th><th>Stok</th><th>ğŸ—‘ï¸</th></tr>';
 products.forEach((p,i)=>{
  stockTable.innerHTML+=`<tr>
   <td><input value="${p.n}" onchange="products[${i}].n=this.value;save()"></td>
   <td><input value="${p.b}" onchange="products[${i}].b=this.value;save()"></td>
   <td><input type="number" value="${p.p}" onchange="products[${i}].p=+this.value;save()"></td>
   <td><input type="number" value="${p.s}" onchange="products[${i}].s=+this.value;save()"></td>
   <td><button onclick="products.splice(${i},1);save()">ğŸ—‘ï¸</button></td>
  </tr>`;
 });
}

// ===== SHITJE =====
scan.addEventListener('keydown',e=>{if(e.key==='Enter')addSale();});
function addSale(){
 const v=scan.value.trim().toLowerCase();
 if(!v)return;
 const p=products.find(x=>x.b===v||x.n.toLowerCase().includes(v));
 if(!p||p.s<1)return alert('Nuk ka stok');
 let s=sales.find(x=>x.b===p.b);
 if(s){if(s.q<p.s)s.q++;}
 else sales.push({b:p.b,n:p.n,p:p.p,q:1});
 scan.value='';
 drawSale();
}
function drawSale(){
 saleTable.innerHTML='<tr><th>Produkt</th><th>Sasi</th><th>Ã‡mim</th><th>Total</th><th>ğŸ—‘ï¸</th></tr>';
 sales.forEach((x,i)=>{
  saleTable.innerHTML+=`<tr>
   <td>${x.n}</td>
   <td><button class="qtyBtn" onclick="chg(${i},-1)">â–</button>${x.q}<button class="qtyBtn" onclick="chg(${i},1)">â•</button></td>
   <td><input type="number" value="${x.p}" onchange="sales[${i}].p=+this.value;drawSale()"></td>
   <td>${x.q*x.p}</td>
   <td><button onclick="sales.splice(${i},1);drawSale()">ğŸ—‘ï¸</button></td>
  </tr>`;
 });
 recalc();
}
function chg(i,d){
 const pr=products.find(p=>p.b===sales[i].b);
 sales[i].q=Math.max(1,Math.min(pr.s,sales[i].q+d));
 drawSale();
}
function recalc(){
 let t=0; sales.forEach(x=>t+=x.q*x.p);
 total.textContent=t;
 change.textContent=(+paid.value||0)-t;
}
paid.oninput=recalc;
function pay(){
 const t=+total.textContent;
 if(t<1)return;
 if(+paid.value<t)return alert('MungojnÃ« para');
 sales.forEach(x=>products.find(p=>p.b===x.b).s-=x.q);
 dailyValue+=t;
 localStorage.setItem('daily',dailyValue);
 sales=[]; saleTable.innerHTML='';
 total.textContent=paid.value=change.textContent=0;
 save(); updateDaily();
}

// ===== BILANC FIX =====
function updateDaily(){document.getElementById('daily').textContent=dailyValue;}
cashReal.oninput=()=>{
 const diffVal=(+cashReal.value||0)-dailyValue;
 diff.textContent=diffVal;
 diff.style.color=diffVal<0?'red':'green';
};
function closeDay(){
 alert(`Shitje sistem: ${dailyValue} ALL`);
 dailyValue=0;
 localStorage.setItem('daily',0);
 cashReal.value=''; diff.textContent='0'; updateDaily();
}

// ===== CAMERA =====
let scanTarget=null;
function openCam(t){
 scanTarget=t;
 camModal.style.display='block';
 Quagga.init({
  inputStream:{type:'LiveStream',target:document.querySelector('#scanner'),constraints:{facingMode:'environment'}},
  decoder:{readers:['ean_reader','ean_8_reader','code_128_reader']}
 },err=>{if(err)return alert('Nuk hapet kamera');Quagga.start();});
 Quagga.onDetected(d=>{
  const code=d.codeResult.code;
  if(scanTarget==='stock')sb.value=code; else{scan.value=code; addSale();}
  closeCam();
 });
}
function closeCam(){Quagga.stop();camModal.style.display='none';}

// ===== SAVE =====
function save(){localStorage.setItem('products',JSON.stringify(products));renderStock();}
</script>
</body>
</html>
